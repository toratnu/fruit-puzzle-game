# ゲーム仕様書

## 1. 概要
本ドキュメントは、フルーツをテーマにした落下物パズルゲームの仕様を定義する。プレイヤーは落下してくるフルーツブロックを操作し、同じ種類のフルーツを繋げて消すことでスコアを獲得する。

本ゲームには、通常のステージクリアを目指す「ノーマルモード」と、制限時間内に高スコアを目指す「スコアアタックモード」の2種類のモードが存在する。

---

## 2. ゲームの目的
- **ノーマルモード**: 制限時間内にフルーツを消してスコアを獲得し、ステージごとに設定された目標スコア（GOAL）の達成を目指す。目標スコアを達成するとステージクリアとなり、次のステージに進む。ゲームオーバーになるまでにより多くのステージをクリアし、ハイスコア（HIGH SCORE）を更新することが最終的な目的となる。
- **スコアアタックモード**: 60秒の制限時間内に、できるだけ多くのスコアを獲得することを目指す。ステージは変化せず、最初からレベル9の状態でプレイする。

---

## 3. 基本的なゲームフロー
1.  **ロード完了**: アセットの読み込みが完了すると、スタート画面が表示される。
2.  **モード選択・ゲーム開始**: スタート画面で「START」（ノーマルモード）または「SCORE ATTACK」（スコアアタックモード）ボタンを選択すると、BGMが再生され、ゲームが開始する。
3.  **ゲームプレイ**:
    - フルーツで構成されたブロックが画面上部から落下する。
    - プレイヤーはブロックを左右に移動、回転させることができる。
    - 同じ種類のフルーツが4つ以上、縦または横に繋がると消え、スコアが加算される。
    - 消えたブロックの上に浮いているブロックは、重力に従って落下する。
    - ブロックが消えた後に、落下したブロックが再び消去条件を満たすと「連鎖（CHAIN）」となる。
4.  **ステージクリア (ノーマルモードのみ)**:
    - 現在のスコア（SCORE）が目標スコア（GOAL）に達すると、ステージクリアとなる。
    - ステージが上がると、ブロックの落下速度が速くなり、目標スコアも上昇する。
5.  **ゲームオーバー**:
    - ブロックがフィールドの一番上まで積み上がる。
    - 制限時間（TIME）が0になる。
6.  **タイトルへ戻る**: ゲームオーバー画面またはステージクリア画面で「Return to Title」ボタンを押すと、スタート画面に戻る。

---

## 4. 画面構成
ゲーム画面は、ゲームボードと情報パネルの2つの主要なエリアで構成される。

### 4.1. スタート画面 (`<div id="start-screen">`)
- ゲーム開始時に表示される画面。
- ゲームタイトル、ハイスコア（HIGH SCORE）、モード選択ボタン（START, SCORE ATTACK）、遊び方ボタンが表示される。

### 4.2. 遊び方画面 (`<div id="how-to-play-screen">`)
- ゲームの操作方法とルールを説明する画面。
- スタート画面から「遊び方」ボタンで遷移し、「戻る」ボタンでスタート画面に戻る。

### 4.3. ゲームボード (`<canvas id="game-board">`)
- ゲームのメインエリア。サイズは `300x600` ピクセル。
- フルーツブロックの落下、操作、消去が行われる。
- 背景にはステージに応じた画像が表示される。
- 現在のステージ番号が薄く表示される。

### 4.4. 情報パネル (`<div id="info-panel">`)
ゲームに関する各種情報が表示される。
- **SCORE**: 現在のステージで獲得したスコア。
- **GOAL**: ステージクリアに必要な目標スコア（ノーマルモードのみ）。
- **LEVEL**: 現在のレベル。消したブロック数に応じて上昇する。
- **CLEARED**: 消したブロックの総数。
- **NEXT**: 次に落下してくるブロックの形状とフルーツの種類が表示される。

### 4.5. ゲームトップバー (`<div id="game-top-bar">`)
- ゲームボード上部に表示される。
- **TIME**: ステージの残り時間（秒）。残り5.5秒以下になると赤く点滅して警告する。
- **一時停止ボタン**: ゲームの一時停止/再開を行う。

### 4.6. モバイル操作ボタン (`<div id="mobile-controls">`)
- スマートフォンなどのタッチデバイス向けに画面下部に表示される。
- 左側に移動ボタン（← →）、中央に回転ボタン（↻）、右側にドロップボタン（↓ ⤓）が配置される。

### 4.7. レスポンシブデザイン
- 画面幅が768px以下の場合、スマートフォンなどのデバイスでも快適にプレイできるよう、以下のレイアウト変更が適用される。
  - ゲームボードと情報パネルが縦に並ぶ。
  - ゲーム全体が画面の高さに合わせて自動的に縮小され、スクロールが発生しない。

---

## 5. ゲームメカニクス

### 5.1. ゲームモード
- **ノーマルモード**: 従来のゲームプレイ。制限時間90秒、レベル1から開始、ステージクリアで次のステージへ。
- **スコアアタックモード**: 制限時間60秒、レベル9から開始、ステージは常に1で固定。目標スコアは存在しない。

### 5.2. ブロックの操作
- `←` キー: ブロックを左に移動
- `→` キー: ブロックを右に移動
- `↓` キー: ブロックを速く落下させる（ソフトドロップ）
- `↑` キー / `スペース` キー: ブロックを時計回りに回転
- `D` キー: ブロックを一気に落とす（ハードドロップ）
- `P` キー: 一時停止 / 再開

### 5.3. ブロックの消去ルール
- 同じ種類のフルーツが**4つ以上**、縦または横一列に隣接すると、そのフルーツブロックが消える。

### 5.4. スコア計算
スコアは以下の要素に基づいて計算される。
- **基本スコア**: `レベル * 10 * 消したブロック数`
- **数量ボーナス**: 一度に5個以上のブロックを消した場合に追加。
- **連鎖ボーナス**: 連鎖数に応じてスコアが `2^(連鎖数-1)` 倍になる。

### 5.5. レベルとステージ
- **レベル**:
  - 消したブロックの総数（CLEARED）が一定数（`32`個）を超えるごとにレベルアップする。
  - レベルが上がると、ブロックの落下速度が上昇し、スコア計算の基礎点も上がる。
- **ステージ**:
  - 目標スコア（GOAL）を達成するとステージクリア（ノーマルモードのみ）。
  - 次のステージに進むと、ボードやスコアがリセットされ、より高い目標スコアと速い落下速度で再開する。

---

## 6. 視覚エフェクト

- **単発消去 (1～4個)**:
  - 消えた位置からランダムな小粒パーティクル（星・水玉）が10～15個発生し、0.4秒で消える。
- **大規模消去 (5個以上)**:
  - 消えた位置から爆発的に拡散するパーティクルが30個発生し、0.6秒で消える。
  - 画面が0.3秒間、振幅0.2で小刻みに揺れる（画面シェイク）。
- **連鎖 (CHAIN)**:
  - 画面中央に「X CHAIN!」という文字列がポップアップ表示され、1秒でフェードアウトする。
  - 連鎖数に応じてパーティクルの色が段階的に変化する（1連鎖目:青、2連鎖目:緑、3連鎖目:黄、4連鎖目以上:赤）。
- **レベルアップ**:
  - 画面中央に「LEVEL UP!」という文字列がポップアップ表示され、光輪のようなエフェクトと共にフェードイン/表示/フェードアウトする（合計1.2秒）。
- **タイム警告**:
  - 残り時間が5.5秒以下になると、画面全体が赤い光で点滅する（0.5秒間隔で点滅）。
- **ハイスコア更新**:
  - ゲーム終了時にハイスコアを更新した場合、スタート画面のハイスコア表示が光るアニメーションで強調される。

---

## 7. サウンド

- **BGM**: `bgm.m4a`
- **効果音**:
  - `land.mp3`: ブロック着地音
  - `clear.mp3`: ブロック消去音（1連鎖目にも使用）
  - `level_up.mp3`: レベルアップ音
  - `chain.mp3`: 連鎖音（2連鎖目以降に使用）
  - `gameOver`: `level_up.mp3`を仮使用
  - `stageClear`: `clear.mp3`を仮使用

---

## 8. 技術仕様
- **言語**: HTML5, CSS3, JavaScript (ES6+)
- **API**:
  - **Canvas 2D API**: ゲームの描画全般に使用。
  - **Web Audio API**: BGMおよび効果音の再生に使用。
- **その他**:
  - **localStorage**: ハイスコアの永続的な保存に使用。
  - **CORSポリシー対策**: ゲームの実行にはローカルWebサーバーが必要。
